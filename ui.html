<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg);
      padding: 12px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼© */
      min-height: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼© */
    }
    
    .header {
      margin-bottom: 12px;
    }
    
    .title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--figma-color-text);
    }
    
    .search-box {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .search-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      font-size: 12px;
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      outline: none;
    }
    
    .search-input:focus {
      border-color: var(--figma-color-border-brand);
    }
    
    .search-input::placeholder {
      color: var(--figma-color-text-tertiary);
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .btn-primary {
      background: var(--figma-color-bg-brand);
      color: white;
    }
    
    .btn-primary:hover {
      opacity: 0.9;
    }
    
    .btn-secondary {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
    }
    
    .btn-secondary:hover {
      background: var(--figma-color-bg-tertiary);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .status-bar {
      padding: 8px 12px;
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 11px;
      color: var(--figma-color-text-secondary);
    }
    
    .status-bar.loading {
      color: var(--figma-color-text-brand);
    }
    
    .status-bar.error {
      color: var(--figma-color-text-danger);
      background: var(--figma-color-bg-danger);
    }
    
    .status-bar.success {
      color: var(--figma-color-text-success);
    }
    
    .results-wrapper {
      flex: 1;
      overflow-y: auto;
      overflow-x: auto; /* æ”¯æŒæ¨ªå‘çºµå‘æ»šåŠ¨ */
      margin-top: 12px;
      min-width: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼© */
    }
    
    .results-container {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr)); /* ä½¿ç”¨minmaxç¡®ä¿è‡ªé€‚åº”ä¸”ä¸è¶…å‡º */
      gap: 12px;
      padding: 8px;
      min-height: min-content;
      width: 100%;
      box-sizing: border-box; /* ç¡®ä¿paddingè®¡ç®—åœ¨å†… */
      max-width: 100%; /* ä¸è¶…å‡ºçˆ¶å®¹å™¨ */
    }
    
    .result-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      background: var(--figma-color-bg-secondary);
      border: 2px solid var(--figma-color-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
      min-width: 0; /* å…è®¸å¡ç‰‡æ”¶ç¼© */
      max-width: 100%; /* ä¸è¶…å‡ºå®¹å™¨ */
      box-sizing: border-box; /* ç¡®ä¿paddingå’Œborderè®¡ç®—åœ¨å†… */
    }
    
    .result-card:hover {
      border-color: var(--figma-color-border-brand);
      background: var(--figma-color-bg-tertiary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .result-thumbnail-wrapper {
      width: 100%;
      height: 150px;
      border-radius: 6px;
      background: var(--figma-color-bg);
      border: 1px solid var(--figma-color-border);
      margin-bottom: 8px;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      box-sizing: border-box; /* ç¡®ä¿paddingè®¡ç®—åœ¨å†… */
      min-width: 0; /* å…è®¸æ”¶ç¼© */
    }
    
    .result-thumbnail {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain; /* ç­‰æ¯”ç¼©æ”¾ï¼Œå®Œæ•´æ˜¾ç¤ºå›¾ç‰‡ */
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }
    
    .result-thumbnail.placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--figma-color-text-tertiary);
      font-size: 48px;
    }
    
    .result-info {
      width: 100%;
      text-align: center;
      min-width: 0; /* å…è®¸æ”¶ç¼© */
      box-sizing: border-box;
    }
    
    .result-name {
      font-weight: 600;
      font-size: 12px;
      color: var(--figma-color-text);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
    }
    
    .result-library {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
    }
    
    .result-score {
      font-size: 10px;
      color: var(--figma-color-text-tertiary);
      background: var(--figma-color-bg);
      padding: 2px 8px;
      border-radius: 12px;
      display: inline-block;
    }
    
    .result-rank {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 24px;
      height: 24px;
      background: var(--figma-color-bg-brand);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--figma-color-text-tertiary);
    }
    
    .empty-state-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }
    
    .toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      align-items: center;
    }
    
    .library-select {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      font-size: 12px;
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      outline: none;
      cursor: pointer;
    }
    
    .library-select:focus {
      border-color: var(--figma-color-border-brand);
    }
    
    .library-select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .component-count {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      margin-left: auto;
      display: flex;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">AI ç»„ä»¶æ£€ç´¢å™¨</div>
  </div>
  
  <div class="toolbar">
    <select class="library-select" id="librarySelect" onchange="onLibraryChange()" disabled>
      <option value="">æ­£åœ¨åŠ è½½ç»„ä»¶åº“...</option>
    </select>
    <div class="component-count" id="componentCount"></div>
  </div>
  
  <div class="search-box">
    <input 
      type="text" 
      class="search-input" 
      id="searchInput" 
      placeholder="è¾“å…¥å…³é”®è¯æœç´¢ç»„ä»¶ï¼ˆæ”¯æŒé¦–å­—æ¯åŒ¹é…ï¼‰..."
      oninput="handleInput(event)"
      onkeypress="handleKeyPress(event)"
    >
    <button class="btn btn-primary" id="searchBtn" onclick="search()">æœç´¢</button>
  </div>
  
  <div class="main-content">
    <div class="status-bar" id="statusBar">æ­£åœ¨åˆå§‹åŒ–...</div>
    
    <div class="results-wrapper">
      <div class="results-container" id="resultsContainer">
        <div class="empty-state" style="grid-column: 1 / -1;">
          <div class="empty-state-icon">ğŸ”</div>
          <div>è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢ç»„ä»¶</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // æ‡’åŠ è½½ç›¸å…³çŠ¶æ€
    const PAGE_SIZE = 30; // æ¯é¡µæ˜¾ç¤ºçš„æ•°é‡
    var allResults = []; // æ‰€æœ‰æœç´¢ç»“æœ
    var displayedCount = 0; // å·²æ˜¾ç¤ºçš„æ•°é‡
    var isLoadingMore = false; // æ˜¯å¦æ­£åœ¨åŠ è½½æ›´å¤š
    
    // åˆå§‹åŒ–
    window.onload = function() {
      parent.postMessage({ pluginMessage: { type: 'init' } }, '*');
      
      // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œå®ç°æ‡’åŠ è½½
      const resultsWrapper = document.querySelector('.results-wrapper');
      if (resultsWrapper) {
        resultsWrapper.addEventListener('scroll', handleScroll);
      }
    };
    
    // å¤„ç†æ»šåŠ¨äº‹ä»¶
    function handleScroll(event) {
      const container = event.target;
      if (!container) return;
      
      const scrollTop = container.scrollTop;
      const scrollHeight = container.scrollHeight;
      const clientHeight = container.clientHeight;
      
      // æ»šåŠ¨åˆ°åº•éƒ¨é™„è¿‘æ—¶ï¼ˆè·ç¦»åº•éƒ¨50pxï¼‰ï¼ŒåŠ è½½æ›´å¤š
      if (scrollHeight - scrollTop - clientHeight < 50 && !isLoadingMore && displayedCount < allResults.length) {
        loadMore();
      }
    }
    
    // åŠ è½½æ›´å¤šç»“æœ
    function loadMore() {
      if (displayedCount >= allResults.length) {
        return; // æ²¡æœ‰æ›´å¤šç»“æœäº†
      }
      
      isLoadingMore = true;
      
      // è®¡ç®—æœ¬æ¬¡è¦åŠ è½½çš„æ•°é‡
      const nextCount = Math.min(displayedCount + PAGE_SIZE, allResults.length);
      const itemsToAdd = allResults.slice(displayedCount, nextCount);
      
      // æ¸²æŸ“æ–°ç»“æœ
      appendResults(itemsToAdd, displayedCount);
      displayedCount = nextCount;
      
      // æ›´æ–°çŠ¶æ€
      if (displayedCount >= allResults.length) {
        updateStatus(`æ‰¾åˆ° ${allResults.length} ä¸ªåŒ¹é…ç»„ä»¶ï¼ˆå·²å…¨éƒ¨åŠ è½½ï¼‰`, 'success');
      } else {
        updateStatus(`æ‰¾åˆ° ${allResults.length} ä¸ªåŒ¹é…ç»„ä»¶ï¼Œå·²æ˜¾ç¤º ${displayedCount} ä¸ª`, 'success');
      }
      
      isLoadingMore = false;
    }
    
    // å®æ—¶æœç´¢ï¼ˆè¾“å…¥æ¡†å†…å®¹æ”¹å˜æ—¶è§¦å‘ï¼‰
    var searchTimeout = null;
    function handleInput(event) {
      // æ¸…é™¤ä¹‹å‰çš„å»¶æ—¶
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      // ä½¿ç”¨é˜²æŠ–ï¼Œå»¶è¿Ÿ100msæ‰§è¡Œæœç´¢ï¼Œç¡®ä¿å®æ—¶å“åº”ä¸”æ— å¡é¡¿
      searchTimeout = setTimeout(function() {
        search();
      }, 50); // 50mså»¶è¿Ÿï¼Œç¡®ä¿å“åº”å»¶è¿Ÿâ‰¤100ms
    }
    
    // æœç´¢
    function search() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) {
        // æ¸…ç©ºç»“æœ
        allResults = [];
        displayedCount = 0;
        renderResults([]);
        updateStatus('è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢ç»„ä»¶', 'success');
        return;
      }
      
      // å®æ—¶æœç´¢ä¸éœ€è¦æ˜¾ç¤ºloadingçŠ¶æ€ï¼Œç›´æ¥æœç´¢
      parent.postMessage({ pluginMessage: { type: 'search', query: query } }, '*');
    }
    
    // å›è½¦æœç´¢ï¼ˆä¿ç•™ç”¨äºå…¼å®¹æ€§ï¼‰
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        // æ¸…é™¤é˜²æŠ–å»¶æ—¶ï¼Œç«‹å³æœç´¢
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }
        search();
      }
    }
    
    // ç»„ä»¶åº“åˆ‡æ¢
    function onLibraryChange() {
      const select = document.getElementById('librarySelect');
      const selectedLibrary = select.value;
      const query = document.getElementById('searchInput').value.trim();
      
      // æ¸…ç©ºå½“å‰ç»“æœ
      allResults = [];
      displayedCount = 0;
      
      if (query) {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'select-library', 
            libraryFileKey: selectedLibrary,
            query: query
          } 
        }, '*');
      } else {
        renderResults([]);
      }
    }
    
    // æ’å…¥ç»„ä»¶
    function insertComponent(componentKey) {
      updateStatus('æ­£åœ¨æ’å…¥ç»„ä»¶...', 'loading');
      parent.postMessage({ pluginMessage: { type: 'insert', componentKey: componentKey } }, '*');
    }
    
    // æ›´æ–°çŠ¶æ€æ 
    function updateStatus(message, type) {
      const statusBar = document.getElementById('statusBar');
      statusBar.textContent = message;
      statusBar.className = 'status-bar';
      if (type) {
        statusBar.classList.add(type);
      }
    }
    
    // æ›´æ–°ç»„ä»¶è®¡æ•°
    function updateComponentCount(count) {
      const countEl = document.getElementById('componentCount');
      countEl.textContent = count ? `å…± ${count} ä¸ªç»„ä»¶` : '';
    }
    
    // æ¸²æŸ“æœç´¢ç»“æœï¼ˆé¦–æ¬¡æ¸²æŸ“æˆ–æ¸…ç©ºï¼‰
    function renderResults(results) {
      const container = document.getElementById('resultsContainer');
      
      // é‡ç½®çŠ¶æ€
      allResults = results || [];
      displayedCount = 0;
      
      if (!allResults || allResults.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-state-icon">ğŸ˜•</div>
            <div>æœªæ‰¾åˆ°åŒ¹é…çš„ç»„ä»¶</div>
          </div>
        `;
        return;
      }
      
      // æ¸…ç©ºå®¹å™¨
      container.innerHTML = '';
      
      // åŠ è½½ç¬¬ä¸€é¡µ
      const firstPage = allResults.slice(0, Math.min(PAGE_SIZE, allResults.length));
      displayedCount = firstPage.length;
      appendResults(firstPage, 0);
    }
    
    // è¿½åŠ ç»“æœåˆ°å®¹å™¨ï¼ˆç”¨äºæ‡’åŠ è½½ï¼‰
    function appendResults(items, startIndex) {
      const container = document.getElementById('resultsContainer');
      
      items.forEach((item, index) => {
        const actualIndex = startIndex + index;
        const card = document.createElement('div');
        card.className = 'result-card';
        card.onclick = function() {
          insertComponent(item.key);
        };
        card.title = escapeHtml(item.name);
        
        card.innerHTML = `
          <div class="result-rank">${actualIndex + 1}</div>
          <div class="result-thumbnail-wrapper">
            ${item.thumbnail 
              ? `<img class="result-thumbnail" src="${item.thumbnail}" alt="${escapeHtml(item.name)}">`
              : `<div class="result-thumbnail placeholder">ğŸ“¦</div>`
            }
          </div>
          <div class="result-info">
            <div class="result-name" title="${escapeHtml(item.name)}">${escapeHtml(item.name)}</div>
            <div class="result-library" title="${escapeHtml(item.libraryName)}">${escapeHtml(item.libraryName)}</div>
            <div class="result-score">${((item.score || item.keywordScore || item.vectorScore || 0) * 100).toFixed(1)}%</div>
          </div>
        `;
        
        container.appendChild(card);
      });
    }
    
    // HTMLè½¬ä¹‰
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // ç›‘å¬æ¥è‡ªæ’ä»¶çš„æ¶ˆæ¯
    window.onmessage = function(event) {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      switch (msg.type) {
        case 'libraries-loaded':
          // æ›´æ–°ä¸‹æ‹‰æ¡†é€‰é¡¹
          const select = document.getElementById('librarySelect');
          select.innerHTML = '';
          if (msg.libraries && msg.libraries.length > 0) {
            msg.libraries.forEach(function(lib) {
              const option = document.createElement('option');
              option.value = lib.fileKey;
              option.textContent = lib.name;
              select.appendChild(option);
            });
            // è®¾ç½®é€‰ä¸­çš„ç»„ä»¶åº“
            if (msg.selectedLibrary) {
              select.value = msg.selectedLibrary;
            }
            select.disabled = false;
          }
          break;
          
        case 'loading-start':
          // æ˜¾ç¤ºåŠ è½½å¼€å§‹ä¿¡æ¯ï¼Œå¦‚æœçŸ¥é“æ€»æ•°åˆ™æ˜¾ç¤ºè¿›åº¦
          var loadingMessage = msg.message;
          if (msg.totalComponents && msg.totalComponents > 0) {
            loadingMessage = 'æ­£åœ¨åŠ è½½ç»„ä»¶åº“... (0/' + msg.totalComponents + ')';
          }
          updateStatus(loadingMessage, 'loading');
          document.getElementById('librarySelect').disabled = true;
          document.getElementById('searchBtn').disabled = true;
          break;
          
        case 'loading-progress':
          // æ˜¾ç¤ºåŠ è½½è¿›åº¦ï¼šå·²åŠ è½½ 384/8391
          var progressMessage = msg.message;
          if (msg.loadedCount !== undefined && msg.totalComponents && msg.totalComponents > 0) {
            progressMessage = msg.message + ' - å·²åŠ è½½ ' + msg.loadedCount + '/' + msg.totalComponents;
          } else if (msg.loadedCount !== undefined && msg.totalComponents === 0) {
            // å¦‚æœä¸çŸ¥é“æ€»æ•°ï¼Œåªæ˜¾ç¤ºå·²åŠ è½½æ•°é‡
            progressMessage = msg.message + ' - å·²åŠ è½½ ' + msg.loadedCount;
          }
          updateStatus(progressMessage, 'loading');
          break;
          
        case 'loading-complete':
          updateStatus(msg.message, 'success');
          updateComponentCount(msg.totalComponents);
          document.getElementById('librarySelect').disabled = false;
          document.getElementById('searchBtn').disabled = false;
          break;
          
        case 'loading-error':
          updateStatus(msg.message, 'error');
          document.getElementById('librarySelect').disabled = false;
          document.getElementById('searchBtn').disabled = false;
          break;
          
        case 'search-results':
          const totalCount = msg.results ? msg.results.length : 0;
          const initialDisplay = Math.min(totalCount, PAGE_SIZE);
          if (totalCount === 0) {
            updateStatus('æœªæ‰¾åˆ°åŒ¹é…çš„ç»„ä»¶', 'success');
          } else if (totalCount <= PAGE_SIZE) {
            updateStatus(`æ‰¾åˆ° ${totalCount} ä¸ªåŒ¹é…ç»„ä»¶`, 'success');
          } else {
            updateStatus(`æ‰¾åˆ° ${totalCount} ä¸ªåŒ¹é…ç»„ä»¶ï¼Œå·²æ˜¾ç¤º ${initialDisplay} ä¸ª`, 'success');
          }
          renderResults(msg.results);
          break;
          
        case 'insert-success':
          updateStatus(msg.message, 'success');
          break;
          
        case 'insert-error':
          updateStatus(msg.message, 'error');
          break;
      }
    };
  </script>
</body>
</html>

